/*
 GNU EXTERNAL BALLISTICS LIBRARY

 This program is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public License
 as published by the Free Software Foundation; version 2
 of the License.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

*/

#include "ballistics.h"

/* Retardation calculations */

double libballistics_computeRetardation (
    int dragFunction, 
    double bC, 
    double velocity)
{
    double vp  = velocity;    
    double val = -1;
    double A = -1;
    double M = -1;

    switch (dragFunction) {
        case G1:
            if      (vp > 4230) { A = 1.477404177730177e-04; M = 1.9565; }
            else if (vp > 3680) { A = 1.920339268755614e-04; M = 1.925 ; }
            else if (vp > 3450) { A = 2.894751026819746e-04; M = 1.875 ; }
            else if (vp > 3295) { A = 4.349905111115636e-04; M = 1.825 ; }
            else if (vp > 3130) { A = 6.520421871892662e-04; M = 1.775 ; }
            else if (vp > 2960) { A = 9.748073694078696e-04; M = 1.725 ; }
            else if (vp > 2830) { A = 1.453721560187286e-03; M = 1.675 ; }
            else if (vp > 2680) { A = 2.162887202930376e-03; M = 1.625 ; }
            else if (vp > 2460) { A = 3.209559783129881e-03; M = 1.575 ; }
            else if (vp > 2225) { A = 3.904368218691249e-03; M = 1.55  ; }
            else if (vp > 2015) { A = 3.222942271262336e-03; M = 1.575 ; }
            else if (vp > 1890) { A = 2.203329542297809e-03; M = 1.625 ; }
            else if (vp > 1810) { A = 1.511001028891904e-03; M = 1.675 ; }
            else if (vp > 1730) { A = 8.609957592468259e-04; M = 1.75  ; }
            else if (vp > 1595) { A = 4.086146797305117e-04; M = 1.85  ; }
            else if (vp > 1520) { A = 1.954473210037398e-04; M = 1.95  ; }
            else if (vp > 1420) { A = 5.431896266462351e-05; M = 2.125 ; }
            else if (vp > 1360) { A = 8.847742581674416e-06; M = 2.375 ; }
            else if (vp > 1315) { A = 1.456922328720298e-06; M = 2.625 ; }
            else if (vp > 1280) { A = 2.419485191895565e-07; M = 2.875 ; }
            else if (vp > 1220) { A = 1.657956321067612e-08; M = 3.25  ; }
            else if (vp > 1185) { A = 4.745469537157371e-10; M = 3.75  ; }
            else if (vp > 1150) { A = 1.379746590025088e-11; M = 4.25  ; }
            else if (vp > 1100) { A = 4.070157961147882e-13; M = 4.75  ; }
            else if (vp > 1060) { A = 2.938236954847331e-14; M = 5.125 ; }
            else if (vp > 1025) { A = 1.228597370774746e-14; M = 5.25  ; }
            else if (vp >  980) { A = 2.916938264100495e-14; M = 5.125 ; }
            else if (vp >  945) { A = 3.855099424807451e-13; M = 4.75  ; }
            else if (vp >  905) { A = 1.185097045689854e-11; M = 4.25  ; }
            else if (vp >  860) { A = 3.566129470974951e-10; M = 3.75  ; }
            else if (vp >  810) { A = 1.045513263966272e-08; M = 3.25  ; }
            else if (vp >  780) { A = 1.291159200846216e-07; M = 2.875 ; }
            else if (vp >  750) { A = 6.824429329105383e-07; M = 2.625 ; }
            else if (vp >  700) { A = 3.569169672385163e-06; M = 2.375 ; }
            else if (vp >  640) { A = 1.839015095899579e-05; M = 2.125 ; }
            else if (vp >  600) { A = 5.71117468873424e-05 ; M = 1.950 ; }
            else if (vp >  550) { A = 9.226557091973427e-05; M = 1.875 ; }
            else if (vp >  250) { A = 9.337991957131389e-05; M = 1.875 ; }
            else if (vp >  100) { A = 7.225247327590413e-05; M = 1.925 ; }
            else if (vp >   65) { A = 5.792684957074546e-05; M = 1.975 ; }
            else if (vp >    0) { A = 5.206214107320588e-05; M = 2.000 ; }
            break;
        case G2:
            if (vp > 1674)
                { A = .0079470052136733;     M = 1.36999902851493; }
            else if (vp > 1172) 
                { A = 1.00419763721974e-03;  M = 1.65392237010294; }
            else if (vp > 1060) 
                { A = 7.15571228255369e-23;  M = 7.91913562392361; }
            else if (vp >  949) 
                { A = 1.39589807205091e-10;  M = 3.81439537623717; }
            else if (vp >  670) 
                { A = 2.34364342818625e-04;  M = 1.71869536324748; }
            else if (vp >  335) 
                { A = 1.77962438921838e-04;  M = 1.76877550388679; }
            else if (vp >    0) 
                { A = 5.18033561289704e-05;  M = 1.98160270524632; }
            break;
        case G5:
            if (vp > 1730)
                { A = 7.24854775171929e-03; M = 1.41538574492812; }
            else if (vp > 1228)
                { A = 3.50563361516117e-05; M = 2.13077307854948; }
            else if (vp > 1116)
                { A = 1.84029481181151e-13; M = 4.81927320350395; }
            else if (vp > 1004)
                { A = 1.34713064017409e-22; M = 7.8100555281422 ; }
            else if (vp >  837)
                { A = 1.03965974081168e-07; M = 2.84204791809926; }
            else if (vp >  335)
                { A = 1.09301593869823e-04; M = 1.81096361579504; }
            else if (vp >    0)
                { A = 3.51963178524273e-05; M = 2.00477856801111; }    
            break;
        case G6:
            if (vp > 3236) 
                { A = 0.0455384883480781;    M = 1.15997674041274; }
            else if (vp > 2065)
                { A = 7.167261849653769e-02; M = 1.10704436538885; }
            else if (vp > 1311)
                { A = 1.66676386084348e-03;  M = 1.60085100195952; }
            else if (vp > 1144)
                { A = 1.01482730119215e-07;  M = 2.9569674731838 ; }
            else if (vp > 1004)
                 { A = 4.31542773103552e-18; M = 6.34106317069757; }
            else if (vp >  670)
                 { A = 2.04835650496866e-05; M = 2.11688446325998; }
            else if (vp >    0)
                 { A = 7.50912466084823e-05 ; M = 1.92031057847052; }
            break;
        case G7:
            if (vp > 4200) 
                { A = 1.29081656775919e-09; M = 3.24121295355962; }
            else if (vp > 3000)
                { A = 0.0171422231434847;   M = 1.27907168025204; }
            else if (vp > 1470)
                { A = 2.33355948302505e-03; M = 1.52693913274526; }
            else if (vp > 1260)
                { A = 7.97592111627665e-04; M = 1.67688974440324; }
            else if (vp > 1110)
                { A = 5.71086414289273e-12; M = 4.3212826264889 ; }
            else if (vp >  960)
                { A = 3.02865108244904e-17; M = 5.99074203776707; }
            else if (vp >  670)
                { A = 7.52285155782535e-06; M = 2.1738019851075 ; }
            else if (vp >  540)
                { A = 1.31766281225189e-05; M = 2.08774690257991; }
            else if (vp >    0)
                { A = 1.34504843776525e-05; M = 2.08702306738884; }
            break;
        case G8:
            if (vp > 3571) 
                { A = .0112263766252305;    M = 1.33207346655961; }
            else if (vp > 1841)
                { A = .0167252613732636;    M = 1.28662041261785; }
            else if (vp > 1120)
                { A = 2.20172456619625e-03; M = 1.55636358091189; }
            else if (vp > 1088)
                { A = 2.0538037167098e-16;  M = 5.80410776994789; }
            else if (vp >  976)
                { A = 5.92182174254121e-12; M = 4.29275576134191; }
            else if (vp >    0)
                { A = 4.3917343795117e-05 ; M = 1.99978116283334; }
            break;
        default:
            break;
    }

    if (A != -1 && M != -1 && vp > 0 && vp < 10000) {
        val = A * pow(vp, M) / bC;
        return val;
    }

    return -1;
}

double libballistics_dragForModel(int dragModel, double velocity, double temperature) {
	double *dragTable[9] = { 0, 0, 0, 0, 0, 0, 0, 0, 0 };
        double *table, machValue;
        int i;
	double G1[] = {
		0.00,	0.2629,
		0.05,	0.2558,
		0.10,	0.2487,
		0.15,	0.2413,
		0.20,	0.2344,
		0.25,	0.2278,
		0.30,	0.2214,
		0.35,	0.2155,
		0.40,	0.2104,
		0.45,	0.2061,
		0.50,	0.2032,
		0.55,	0.2020,
		0.60,	0.2034,
		0.70,	0.2165,
		0.725,	0.2230,
		0.75,	0.2313,
		0.775,	0.2417,
		0.80,	0.2546,
		0.825,	0.2706,
		0.85,	0.2901,
		0.875,	0.3136,
		0.90,	0.3415,
		0.925,	0.3734,
		0.95,	0.4084,
		0.975,	0.4448,
		1.0,	0.4805,
		1.025,	0.5136,
		1.05,	0.5427,
		1.075,	0.5677,
		1.10,	0.5883,
		1.125,	0.6053,
		1.15,	0.6191,
		1.20,	0.6393,
		1.25,	0.6518,
		1.30,	0.6589,
		1.35,	0.6621,
		1.40,	0.6625,
		1.45,	0.6607,
		1.50,	0.6573,
		1.55,	0.6528,
		1.60,	0.6474,
		1.65,	0.6413,
		1.70,	0.6347,
		1.75,	0.6280,
		1.80,	0.6210,
		1.85,	0.6141,
		1.90,	0.6072,
		1.95,	0.6003,
		2.00,	0.5934,
		2.05,	0.5867,
		2.10,	0.5804,
		2.15,	0.5743,
		2.20,	0.5685,
		2.25,	0.5630,
		2.30,	0.5577,
		2.35,	0.5527,
		2.40,	0.5481,
		2.45,	0.5438,
		2.50,	0.5397,
		2.60,	0.5325,
		2.70,	0.5264,
		2.80,	0.5211,
		2.90,	0.5168,
		3.00,	0.5133,
		3.10,	0.5105,
		3.20,	0.5084,
		3.30,	0.5067,
		3.40,	0.5054,
		3.50,	0.5040,
		3.60,	0.5030,
		3.70,	0.5022,
		3.80,	0.5016,
		3.90,	0.5010,
		4.00,	0.5006,
		4.20,	0.4998,
		4.40,	0.4995,
		4.60,	0.4992,
		4.80,	0.4990,
		5.00,	0.4988
	};
	
	double G2[] = {
		0.00,	0.2303,
		0.05,	0.2298,
		0.10,	0.2287,
		0.15,	0.2271,
		0.20,	0.2251,
		0.25,	0.2227,
		0.30,	0.2196,
		0.35,	0.2156,
		0.40,	0.2107,
		0.45,	0.2048,
		0.50,	0.1980,
		0.55,	0.1905,
		0.60,	0.1828,
		0.65,	0.1758,
		0.70,	0.1702,
		0.75,	0.1669,
		0.775,	0.1664,
		0.80,	0.1667,
		0.825,	0.1682,
		0.85,	0.1711,
		0.875,	0.1761,
		0.90,	0.1831,
		0.925,	0.2004,
		0.95,	0.2589,
		0.975,	0.3492,
		1.0,	0.3983,
		1.025,	0.4075,
		1.05,	0.4103,
		1.075,	0.4114,
		1.10,	0.4106,
		1.125,	0.4089,
		1.15,	0.4068,
		1.175,	0.4046,
		1.20,	0.4021,
		1.25,	0.3966,
		1.30,	0.3904,
		1.35,	0.3835,
		1.40,	0.3759,
		1.45,	0.3678,
		1.50,	0.3594,
		1.55,	0.3512,
		1.60,	0.3432,
		1.65,	0.3356,
		1.70,	0.3282,
		1.75,	0.3213,
		1.80,	0.3149,
		1.85,	0.3089,
		1.90,	0.3033,
		1.95,	0.2982,
		2.00,	0.2933,
		2.05,	0.2889,
		2.10,	0.2846,
		2.15,	0.2806,
		2.20,	0.2768,
		2.25,	0.2731,
		2.30,	0.2696,
		2.35,	0.2663,
		2.40,	0.2632,
		2.45,	0.2602,
		2.50,	0.2572,
		2.55,	0.2543,
		2.60,	0.2515,
		2.65,	0.2487,
		2.70,	0.2460,
		2.75,	0.2433,
		2.80,	0.2408,
		2.85,	0.2382,
		2.90,	0.2357,
		2.95,	0.2333,
		3.00,	0.2309,
		3.10,	0.2262,
		3.20,	0.2217,
		3.30,	0.2173,
		3.40,	0.2132,
		3.50,	0.2091,
		3.60,	0.2052,
		3.70,	0.2014,
		3.80,	0.1978,
		3.90,	0.1944,
		4.00,	0.1912,
		4.20,	0.1851,
		4.40,	0.1794,
		4.60,	0.1741,
		4.80,	0.1693,
		5.00,	0.1648
	};
	
	double G5[] = {
		0.00,	0.1710,
		0.05,	0.1719,
		0.10,	0.1727,
		0.15,	0.1732,
		0.20,	0.1734,
		0.25,	0.1730,
		0.30,	0.1718,
		0.35,	0.1696,
		0.40,	0.1668,
		0.45,	0.1637,
		0.50,	0.1603,
		0.55,	0.1566,
		0.60,	0.1529,
		0.65,	0.1497,
		0.70,	0.1473,
		0.75,	0.1463,
		0.80,	0.1489,
		0.85,	0.1583,
		0.875,	0.1672,
		0.90,	0.1815,
		0.925,	0.2051,
		0.95,	0.2413,
		0.975,	0.2884,
		1.0,	0.3379,
		1.025,	0.3785,
		1.05,	0.4032,
		1.075,	0.4147,
		1.10,	0.4201,
		1.15,	0.4278,
		1.20,	0.4338,
		1.25,	0.4373,
		1.30,	0.4392,
		1.35,	0.4403,
		1.40,	0.4406,
		1.45,	0.4401,
		1.50,	0.4386,
		1.55,	0.4362,
		1.60,	0.4328,
		1.65,	0.4286,
		1.70,	0.4237,
		1.75,	0.4182,
		1.80,	0.4121,
		1.85,	0.4057,
		1.90,	0.3991,
		1.95,	0.3926,
		2.00,	0.3861,
		2.05,	0.3800,
		2.10,	0.3741,
		2.15,	0.3684,
		2.20,	0.3630,
		2.25,	0.3578,
		2.30,	0.3529,
		2.35,	0.3481,
		2.40,	0.3435,
		2.45,	0.3391,
		2.50,	0.3349,
		2.60,	0.3269,
		2.70,	0.3194,
		2.80,	0.3125,
		2.90,	0.3060,
		3.00,	0.2999,
		3.10,	0.2942,
		3.20,	0.2889,
		3.30,	0.2838,
		3.40,	0.2790,
		3.50,	0.2745,
		3.60,	0.2703,
		3.70,	0.2662,
		3.80,	0.2624,
		3.90,	0.2588,
		4.00,	0.2553,
		4.20,	0.2488,
		4.40,	0.2429,
		4.60,	0.2376,
		4.80,	0.2326,
		5.00,	0.2280		
	};
	
	double G6[] = {
		0.00,	0.2617,
		0.05,	0.2553,
		0.10,	0.2491,
		0.15,	0.2432,
		0.20,	0.2376,
		0.25,	0.2324,
		0.30,	0.2278,
		0.35,	0.2238,
		0.40,	0.2205,
		0.45,	0.2177,
		0.50,	0.2155,
		0.55,	0.2138,
		0.60,	0.2126,
		0.65,	0.2121,
		0.70,	0.2122,
		0.75,	0.2132,
		0.80,	0.2154,
		0.85,	0.2194,
		0.875,	0.2229,
		0.90,	0.2297,
		0.925,	0.2449,
		0.95,	0.2732,
		0.975,	0.3141,
		1.0,	0.3597,
		1.025,	0.3994,
		1.05,	0.4261,
		1.075,	0.4402,
		1.10,	0.4465,
		1.125,	0.4490,
		1.15,	0.4497,
		1.175,	0.4494,
		1.20,	0.4482,
		1.225,	0.4464,
		1.25,	0.4441,
		1.30,	0.4390,
		1.35,	0.4336,
		1.40,	0.4279,
		1.45,	0.4221,
		1.50,	0.4162,
		1.55,	0.4102,
		1.60,	0.4042,
		1.65,	0.3981,
		1.70,	0.3919,
		1.75,	0.3855,
		1.80,	0.3788,
		1.85,	0.3721,
		1.90,	0.3652,
		1.95,	0.3583,
		2.00,	0.3515,
		2.05,	0.3447,
		2.10,	0.3381,
		2.15,	0.3314,
		2.20,	0.3249,
		2.25,	0.3185,
		2.30,	0.3122,
		2.35,	0.3060,
		2.40,	0.3000,
		2.45,	0.2941,
		2.50,	0.2883,
		2.60,	0.2772,
		2.70,	0.2668,
		2.80,	0.2574,
		2.90,	0.2487,
		3.00,	0.2407,
		3.10,	0.2333,
		3.20,	0.2265,
		3.30,	0.2202,
		3.40,	0.2144,
		3.50,	0.2089,
		3.60,	0.2039,
		3.70,	0.1991,
		3.80,	0.1947,
		3.90,	0.1905,
		4.00,	0.1866,
		4.20,	0.1794,
		4.40,	0.1730,
		4.60,	0.1673,
		4.80,	0.1621,
		5.00,	0.1574
	};
	
	double G7[] = {
		0.00,	0.1198,
		0.05,	0.1197,
		0.10,	0.1196,
		0.15,	0.1194,
		0.20,	0.1193,
		0.25,	0.1194,
		0.30,	0.1194,
		0.35,	0.1194,
		0.40,	0.1193,
		0.45,	0.1193,
		0.50,	0.1194,
		0.55,	0.1193,
		0.60,	0.1194,
		0.65,	0.1197,
		0.70,	0.1202,
		0.725,	0.1207,
		0.75,	0.1215,
		0.775,	0.1226,
		0.80,	0.1242,
		0.825,	0.1266,
		0.85,	0.1306,
		0.875,	0.1368,
		0.90,	0.1464,
		0.925,	0.1660,
		0.95,	0.2054,
		0.975,	0.2993,
		1.0,	0.3803,
		1.025,	0.4015,
		1.05,	0.4043,
		1.075,	0.4034,
		1.10,	0.4014,
		1.125,	0.3987,
		1.15,	0.3955,
		1.20,	0.3884,
		1.25,	0.3810,
		1.30,	0.3732,
		1.35,	0.3657,
		1.40,	0.3580,
		1.50,	0.3440,
		1.55,	0.3376,
		1.60,	0.3315,
		1.65,	0.3260,
		1.70,	0.3209,
		1.75,	0.3160,
		1.80,	0.3117,
		1.85,	0.3078,
		1.90,	0.3042,
		1.95,	0.3010,
		2.00,	0.2980,
		2.05,	0.2951,
		2.10,	0.2922,
		2.15,	0.2892,
		2.20,	0.2864,
		2.25,	0.2835,
		2.30,	0.2807,
		2.35,	0.2779,
		2.40,	0.2752,
		2.45,	0.2725,
		2.50,	0.2697,
		2.55,	0.2670,
		2.60,	0.2643,
		2.65,	0.2615,
		2.70,	0.2588,
		2.75,	0.2561,
		2.80,	0.2533,
		2.85,	0.2506,
		2.90,	0.2479,
		2.95,	0.2451,
		3.00,	0.2424,
		3.10,	0.2368,
		3.20,	0.2313,
		3.30,	0.2258,
		3.40,	0.2205,
		3.50,	0.2154,
		3.60,	0.2106,
		3.70,	0.2060,
		3.80,	0.2017,
		3.90,	0.1975,
		4.00,	0.1935,
		4.20,	0.1861,
		4.40,	0.1793,
		4.60,	0.1730,
		4.80,	0.1672,
		5.00,	0.1618
	};
	
	double G8[] = {
		0.00,	0.2105,
		0.05,	0.2105,
		0.10,	0.2104,
		0.15,	0.2104,
		0.20,	0.2103,
		0.25,	0.2103,
		0.30,	0.2103,
		0.35,	0.2103,
		0.40,	0.2103,
		0.45,	0.2102,
		0.50,	0.2102,
		0.55,	0.2102,
		0.60,	0.2102,
		0.65,	0.2102,
		0.70,	0.2103,
		0.75,	0.2103,
		0.80,	0.2104,
		0.825,	0.2104,
		0.85,	0.2105,
		0.875,	0.2106,
		0.90,	0.2109,
		0.925,	0.2183,
		0.95,	0.2571,
		0.975,	0.3358,
		1.0,	0.4068,
		1.025,	0.4378,
		1.05,	0.4476,
		1.075,	0.4493,
		1.10,	0.4477,
		1.125,	0.4450,
		1.15,	0.4419,
		1.20,	0.4353,
		1.25,	0.4283,
		1.30,	0.4208,
		1.35,	0.4133,
		1.40,	0.4059,
		1.45,	0.3986,
		1.50,	0.3915,
		1.55,	0.3845,
		1.60,	0.3777,
		1.65,	0.3710,
		1.70,	0.3645,
		1.75,	0.3581,
		1.80,	0.3519,
		1.85,	0.3458,
		1.90,	0.3400,
		1.95,	0.3343,
		2.00,	0.3288,
		2.05,	0.3234,
		2.10,	0.3182,
		2.15,	0.3131,
		2.20,	0.3081,
		2.25,	0.3032,
		2.30,	0.2983,
		2.35,	0.2937,
		2.40,	0.2891,
		2.45,	0.2845,
		2.50,	0.2802,
		2.60,	0.2720,
		2.70,	0.2642,
		2.80,	0.2569,
		2.90,	0.2499,
		3.00,	0.2432,
		3.10,	0.2368,
		3.20,	0.2308,
		3.30,	0.2251,
		3.40,	0.2197,
		3.50,	0.2147,
		3.60,	0.2101,
		3.70,	0.2058,
		3.80,	0.2019,
		3.90,	0.1983,
		4.00,	0.1950,
		4.20,	0.1890,
		4.40,	0.1837,
		4.60,	0.1791,
		4.80,	0.1750,
		5.00,	0.1713
	};
	
	dragTable[1] = G1;
	dragTable[2] = G2;
	dragTable[5] = G5;
	dragTable[6] = G6;
	dragTable[7] = G7;
	dragTable[8] = G8;
	
	if (dragModel > 8 || dragTable[dragModel] == 0)
		return 1.0;
	
	machValue = velocity / ( sqrt(temperature + LIBBALLISTICS_ABSOLUTE_ZERO) * 49.0223 );
	table = dragTable[dragModel];
	for(i = 0; table[i*2] < 5.0; i++) {
		double mach_lo = table[i*2];
		double mach_hi = table[(i+1)*2];
		double cd_lo = table[(i*2)+1];
		double cd_hi = table[((i+1)*2)+1];
		
		if (machValue >= mach_lo && machValue < mach_hi) {
			double delta_cd = cd_hi - cd_lo;
			double delta_mach = mach_hi - mach_lo;
			double cd = cd_lo + (delta_cd * ( (machValue - mach_lo) / delta_mach) );
			return cd;
		}
	}
	return 1.0;
}

